---
title: "Retrieve WGS data"
author: "Quang Nguyen"
date: "2022-03-23"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  

Here we obtain metagenomic samples from `curatedMetagenomicData` package for certain conditions. We filter the metadata and then retrieve both relative abundance and pathway abundance data sets. We're interested in different conditions of interest: CRC (colorectal cancer), T2D (type II diabetes), and IBD (inflammatory bowel disease). We also collect all samples set to be controls.  

## Implementation
Load packages 

```{r}
library(curatedMetagenomicData)
library(tidyverse)
library(here)
here::i_am(file.path("analysis", "retrieve_wgs.rmd"))
```

Here, we use the metadata to extract out samples that study three conditions of interest: CRC (colorectal cancer), T2D (type II diabetes), and IBD (inflammatory bowel disease). Additionally, we select all samples stated to be controls (without any disease).  
```{r}
metadata <- as_tibble(sampleMetadata)
# names of studies that have these conditions as their primary indicators
s_names <- metadata %>% 
    filter(study_condition %in% c("CRC", "T2D", "IBD")) %>% 
    pull(study_name) %>% unique() # nolint

# retrieve data from those studies alone but also obtain matched controls per data set  
samples <- metadata %>% 
    filter(study_name %in% s_names, study_condition %in% c("CRC", "T2D", "IBD", "control"))

print(paste(nrow(samples), "samples for the per-study data set"))

# getting all control data sets  
control_only <- metadata %>% filter(study_condition == "control")
print(paste(nrow(control_only), "samples for the control only data set")

print(head(samples))
print(head(control_only))
```

We use `returnSamples()` to retreive all relevant data  

```{r}

if (!file.exists(here("large_files", "pred_wgs_cohort.rds"))){
    pred_cohort_relabundance <- returnSamples(samples, 
        "relative_abundance", rownames = "NCBI")
    pred_cohort_pathabundance <- returnSamples(samples, 
        "pathway_abundance", rownames = "NCBI")
    out <- list(relab = pred_cohort_relabundance, 
        pathab = pred_cohort_pathabundance)
    saveRDS(object = out, file = here("large_files", "pred_wgs_cohort.rds"))
    rm(pred_cohort_relabundance)
    rm(pred_cohort_pathabundance)
    rm(out)
    gc()
} 

```

```{r}
if (!file.exists(here("large_files", "control_wgs_cohort.rds"))){
    control_cohort_relabundance <- returnSamples(control_only, "relative_abundance", rownames = "NCBI")
    control_cohort_pathabundance <- returnSamples(control_only, "pathway_abundance", rownames = "NCBI")
    out <- list(relab = control_cohort_relabundance, pathab = pred_cohort_pathabundance)
    saveRDS(object = out, file = here("large_files", "control_wgs_cohort.rds"))
    rm(control_cohort_relabundance)
    rm(control_cohort_pathabundance)
    rm(out)
    gc()

}
```