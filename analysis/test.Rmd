---
title: "Target Markdown"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
if (requireNamespace("knitr", quietly = TRUE)) {
  knitr::knit_engines$set(targets = targets::tar_engine_knitr)
}
```

Target Markdown is a powerful R Markdown interface for reproducible analysis pipelines, and the chapter at https://books.ropensci.org/targets/markdown.html walks through it in detail. This R Markdown report the example from the chapter. Try it out in both interactive and non-interactive modes, either by running the code chunks in different ways or setting the `tar_interactive` chunk option.

Near the top of the document, you may also wish to remove the `_targets_r` directory previously written by non-interactive runs of the report. Otherwise, your pipeline may contain superfluous targets.

```{r}
library(targets)
library(tarchetypes)
tar_unscript()
```

# Globals

We first define some global options/functions common to all targets. The function below plots a histogram of ozone concentrations, and our histogram target will need it.

```{targets example-globals, tar_globals = TRUE}
Sys.setenv(TAR_PROJECT = "dada2_agp")
options(tidyverse.quiet = TRUE)
tar_option_set(packages = c("dada2", "tidyverse", "here", "rlist"))
# this function returns some paths (redefining it for the purposes of global def) 
source(here::here("R", "dada2_func.R"))
base_path <- file.path("rc", "lab", "H", 
                          "HoenA", "Lab", "QNguyen", "ResultsFiles", "data", 
                          "agp")
path_files <- function(){
    if (Sys.info()['sysname'] == "Darwin"){
        filepath <- file.path("/Volumes", base_path)
        if (!file.exists(file.path(filepath, ".placeholder"))){
            stop("This folder does not exist, please mount folder")
        } 
    } else if (Sys.info()['sysname'] == "Linux"){
        filepath <- file.path("/dartfs-hpc", base_path)
    } else {
        stop("OS not supported")
    }
    return(filepath)
}
```

# Targets

Our next targets preprocess the data, make a histogram, and fit a model.

```{targets downstream-targets}
list(
    tar_target(raw_data, path_files(), format = "file"),
    tar_target(f_data, filter_and_trim(raw_data, limit = tar_toggle(TRUE, FALSE))),
    tar_target(l_errors, learn_errors(f_data)),
    tar_target(r_dada, run_dada2(l_errors)),
    tar_target(a_taxonomy, assign_taxonomy(r_dada)),
    tar_rds(save_results, saveRDS(a_taxonomy, file = here("data", "agp_dada2.rds")))
)
```

Set the `tar_simple` chunk option to `TRUE` to define a single target with the command in the code chunk. The chunk below only contains `biglm(Ozone ~ Wind + Temp, data)` in the source, but because `tar_simple` is `TRUE`, it is shorthand for `tar_target(name = fit, command = biglm(Ozone ~ Wind + Temp, data))`. All other arguments to `tar_target()` are set to their default values (configurable with `tar_option_set()`).

# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r}
tar_make()
```

The `targets` dependency graph helps your readers understand the steps of your pipeline at a high level.

```{r}
tar_visnetwork()
```

At this point, you can go back and run `{targets}` chunks in interactive mode without interfering with the code or data of the non-interactive pipeline.

```{targets, tar_interactive=TRUE}


```

