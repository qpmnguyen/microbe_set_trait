---
title: "Retrieve WGS data"
author: "Quang Nguyen"
date: "2022-03-23"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction  

Here we obtain metagenomic samples from `curatedMetagenomicData` package for certain conditions. We filter the metadata and then retrieve both relative abundance and pathway abundance data sets. We're interested in different conditions of interest: CRC (colorectal cancer)  and IBD (inflammatory bowel disease). We also collect all samples set to be controls.  

## Implementation
Load packages 

```{r}
library(curatedMetagenomicData)
library(tidyverse)
library(here)
library(piggyback)
library(qs)
here::i_am(file.path("analysis", "retrieve_wgs.Rmd"))
```

Here, we use the metadata to extract out samples that study three conditions of interest: CRC (colorectal cancer), T1D (type I diabetes), and IBD (inflammatory bowel disease). Additionally, we select all samples stated to be controls (without any disease). 

We are returning each data set as two `qs` files of the `TreeSummarizedExperiment` format and pathway abundances. We use `returnSamples()` to retreive all relevant data.   
```{r}
metadata <- as_tibble(sampleMetadata)

conditions <- c("CRC", "IBD")
for (condition in conditions){
    s_names <- metadata %>% filter(study_condition == condition) %>% 
        pull(study_name) %>% unique()
    samples <- metadata %>% filter(study_name %in% s_names, study_condition %in% c(condition, "control"))
    data <- returnSamples(samples, "relative_abundance", rownames = "NCBI")
    colData(data) <- colData(data)[,c("study_name", "disease", "study_condition")]
    path <- returnSamples(samples, "pathway_abundance")
    path <- path[!str_detect(rownames(path), "\\|")]
    colData(path) <- colData(data)[,c("study_name", "disease", "study_condition")]
    qsave(data, here("data", paste0("pred_relabun_", condition, "_wgs.parquet")))
    qsave(path, here("data", paste0("pred_pathway_", condition, "_wgs.parquet")))
    
    print(paste("This data set has", dim(data)[1], "samples for condition", condition))
}
```

We looped through each condition and then visualize them 